<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi KKG 2026 - STS Semester 2</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        :root { --p: #1e293b; --a: #2563eb; --s: #10b981; --d: #ef4444; --w: #f59e0b; }
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; margin: 0; color: #1e293b; }
        header { background: var(--p); color: white; padding: 15px; text-align: center; border-bottom: 4px solid var(--a); }
        .nav { display: flex; background: white; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 100; }
        .nav-btn { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-weight: 600; color: #64748b; }
        .nav-btn.active { color: var(--a); border-bottom: 3px solid var(--a); background: #f8fafc; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        label { display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; color: #475569; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; box-sizing: border-box; }
        .btn { padding: 10px 15px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; color: white; transition: 0.3s; }
        .btn-blue { background: var(--a); } .btn-green { background: var(--s); } .btn-red { background: var(--d); }
        .btn-sm { padding: 5px 10px; font-size: 12px; margin-right: 5px; }
        .img-pre { max-height: 80px; display: block; margin: 5px 0; border: 1px solid #ddd; }
        .hidden { display: none; }

        @media print {
            @page { size: A4; margin: 1.5cm; }
            body { background: white !important; }
            .no-print { display: none !important; }
            #printArea { width: 100% !important; }
        }

        #printArea { background: white; width: 100%; color: black; }
        .kop-table { width: 100%; border-bottom: 4px double black !important; margin-bottom: 10px; border-collapse: collapse; }
        .kop-table td { border: none !important; padding: 2px !important; vertical-align: middle; }
        .kop-text-center { text-align: center; line-height: 1.1 !important; }
        .kop-text-center h3 { margin: 0; padding: 0; text-transform: uppercase; font-size: 14pt; }

        .table-naskah { width: 100%; border-collapse: collapse; margin-bottom: 5px; }
        .table-naskah td { border: none !important; padding: 2px 0; vertical-align: top; font-size: 11pt; }
        
        #login-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f1f5f9; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .login-card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 350px; }
    </style>
</head>
<body>

<div id="login-page">
    <div class="login-card">
        <h2 style="text-align:center; margin-bottom:20px;">LOGIN KKG 2026</h2>
        <div style="margin-bottom:15px;"><label>Username</label><input type="text" id="lUser" placeholder="admin / guru1 / pai / inggris"></div>
        <div style="margin-bottom:20px;"><label>Password</label><input type="password" id="lPass" placeholder="****"></div>
        <button class="btn btn-blue" style="width:100%;" id="btnLogin">MASUK APLIKASI</button>
        <p id="lMsg" style="color:var(--d); font-size:12px; text-align:center; margin-top:10px;"></p>
    </div>
</div>

<header class="no-print">
    <h2 style="margin:0;">BANK SOAL KKG 2026</h2>
    <div style="display: flex; justify-content: center; gap: 15px; margin-top: 5px;">
        <div id="db-st" style="font-size:12px; font-weight:bold;">MENGHUBUNGKAN...</div>
        <div id="user-display" style="font-size:12px; font-weight:bold; color: #fbbf24;"></div>
    </div>
</header>

<div class="nav no-print">
    <button class="nav-btn active" onclick="showTab('tp')">A. TP</button>
    <button class="nav-btn" onclick="showTab('soal')">B. BUAT SOAL</button>
    <button class="nav-btn" onclick="showTab('cetak')">C. CETAK</button>
    <button class="nav-btn" onclick="showTab('db')">D. DATABASE</button>
    <button class="nav-btn" onclick="location.reload()" style="color:var(--d)">LOGOUT</button>
</div>

<div class="container">
    <div class="card no-print" style="background: #e2e8f0;">
        <div class="grid">
            <div><label>Fokus Kelas</label><select id="selKls" onchange="initData()"></select></div>
            <div><label>Mata Pelajaran</label><select id="selMapel" onchange="initData()"></select></div>
        </div>
    </div>

    <div id="tab-tp" class="tab-content no-print">
        <div class="card">
            <h4>UPLOAD LOGO SEKOLAH</h4>
            <input type="file" accept="image/*" onchange="updateLogo(this)">
            <img id="logo-preview" style="height:60px; margin-top:10px; display:block;">
        </div>
        <div class="card">
            <h4>INPUT TP</h4>
            <input type="hidden" id="fIdTp">
            <div class="grid" style="grid-template-columns: 1fr 3fr;">
                <div><label>Elemen</label><input type="text" id="fElemen"></div>
                <div><label>Isi TP</label><textarea id="fTp" rows="2"></textarea></div>
            </div>
            <button class="btn btn-blue" style="margin-top:10px;" onclick="saveTP()">SIMPAN TP</button>
        </div>
        <div class="card">
            <table style="width:100%; border-collapse: collapse;">
                <thead><tr style="background:#f8fafc;"><th>Elemen</th><th>TP</th><th width="100">Aksi</th></tr></thead>
                <tbody id="bodyTP"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-soal" class="tab-content hidden no-print">
        <div class="card">
            <input type="hidden" id="fIdSoal">
            <div class="grid">
                <div><label>Pilih TP</label><select id="sTP"></select></div>
                <div><label>Indikator</label><input type="text" id="sInd"></div>
                <div><label>Level</label><select id="sLv"><option value="L1">L1</option><option value="L2">L2</option><option value="L3">L3</option></select></div>
                <div><label>Bentuk</label><select id="sBentuk" onchange="toggleForm()"><option value="PG">Pilihan Ganda</option><option value="Esai">Esai</option></select></div>
            </div>
            <div style="margin-top:15px;">
                <label>Pertanyaan</label>
                <textarea id="sTanya" rows="3"></textarea>
            </div>
            <div id="panelPG" style="margin-top:15px;">
                <div class="grid">
                    <div><label>Opsi a</label><input type="text" id="oa"></div>
                    <div><label>Opsi b</label><input type="text" id="ob"></div>
                    <div><label>Opsi c</label><input type="text" id="oc"></div>
                    <div id="od-w"><label>Opsi d</label><input type="text" id="od"></div>
                </div>
            </div>
            <div class="grid" style="margin-top:15px;">
                <div><label>Kunci</label><input type="text" id="sKunci"></div>
                <div><label>Skor</label><input type="number" id="sSkor" value="1"></div>
            </div>
            <button class="btn btn-green" style="width:100%; margin-top:20px;" onclick="saveSoal()">SIMPAN SOAL</button>
        </div>
        <div id="listSoal"></div>
    </div>

    <div id="tab-cetak" class="tab-content hidden">
        <div class="no-print card" style="text-align:center; display:flex; justify-content:center; gap:10px;">
            <button class="btn btn-blue" onclick="window.print()">PRINT / PDF</button>
            <button class="btn btn-green" style="background:#2b5797;" onclick="downloadWord()">DOWNLOAD WORD</button>
        </div>
        <div id="printArea">
            <div id="naskah-container">
                <table class="kop-table">
                    <tr>
                        <td width="12%"><img id="p-logo" src="" style="width:70px;"></td>
                        <td class="kop-text-center">
                            <h3>SUMATIF TENGAH SEMESTER (STS)</h3>
                            <h3>SEMESTER 2 SEKOLAH DASAR</h3>
                            <h3 style="font-size:11pt">TAHUN AJARAN 2025/2026</h3>
                        </td>
                        <td width="12%"></td>
                    </tr>
                </table>
                <table style="width:100%; font-weight:bold; margin-bottom:10px; font-size:11pt;">
                    <tr>
                        <td width="18%">Mata Pelajaran</td><td width="2%">:</td><td width="35%"><span id="p-mapel-val"></span></td>
                        <td width="12%">Nama</td><td width="2%">:</td><td width="31%">...........................</td>
                    </tr>
                    <tr>
                        <td>Kelas</td><td>:</td><td><span id="p-kls-val"></span></td>
                        <td>Nomor</td><td>:</td><td>...........................</td>
                    </tr>
                </table>
                <div style="border-top:1px solid black; border-bottom:1px solid black; padding:3px; font-weight:bold; font-size:10pt; margin-bottom:10px; background:#eee;">I. Berilah tanda silang (X) pada huruf a, b, c, atau d pada jawaban yang paling benar!</div>
                <div id="p-naskah"></div>
                <div style="border-top:1px solid black; border-bottom:1px solid black; padding:3px; font-weight:bold; font-size:10pt; margin:15px 0 10px 0; background:#eee;">II. Isilah titik-titik di bawah ini dengan jawaban yang benar!</div>
                <div id="p-naskah-esai"></div>
            </div>
        </div>
    </div>

    <div id="tab-db" class="tab-content hidden no-print">
        <div class="card">
            <h3>Backup/Restore</h3>
            <button class="btn btn-blue" onclick="exportData()">EXPORT JSON</button>
        </div>
    </div>
</div>

<script>
    // 1. CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyBA3VSLrRL6d9y0HdQM-H0Y7z2VisMHl_I",
        authDomain: "kkgmajalengka2026.firebaseapp.com",
        databaseURL: "https://kkgmajalengka2026-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "kkgmajalengka2026",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let cacheTP = [];
    let currentUser = { role: null, kls: null };

    // 2. LOGIN (Cukup Sekali)
    document.getElementById('btnLogin').onclick = () => {
        const u = document.getElementById('lUser').value.toLowerCase();
        const p = document.getElementById('lPass').value;
        const sK = document.getElementById('selKls');
        
        if(u === 'admin' && p === 'admin123') { 
            currentUser = { role: 'admin', kls: '1' }; 
            sK.innerHTML = [1,2,3,4,5,6].map(v => `<option value="${v}">Kelas ${v}</option>`).join('');
        } else if(u.startsWith('guru') && p === 'guru123') { 
            const k = u.replace('guru',''); 
            currentUser = { role: 'guru', kls: k }; 
            sK.innerHTML = `<option value="${k}">Kelas ${k}</option>`;
        } else if(u === 'pai' && p === 'pai123') { 
            currentUser = { role: 'pai', kls: '1' }; 
            sK.innerHTML = [1,2,3,4,5,6].map(v => `<option value="${v}">Kelas ${v}</option>`).join('');
        } else if(u === 'inggris' && p === 'inggris123') { 
            currentUser = { role: 'inggris', kls: '3' }; 
            sK.innerHTML = [3,4,5,6].map(v => `<option value="${v}">Kelas ${v}</option>`).join('');
        } else { alert("User/Pass Salah!"); return; }

        document.getElementById('user-display').innerText = "USER: " + u.toUpperCase();
        document.getElementById('login-page').style.display = 'none';
        initData();
    };

    function initData() {
        const k = document.getElementById('selKls').value;
        const sM = document.getElementById('selMapel');
        let opts = ["Pendidikan Pancasila", "Bahasa Indonesia", "Matematika", "Seni Budaya", "Bahasa Sunda"];
        if(parseInt(k) >= 3) opts.push("IPAS");
        if(currentUser.role === 'pai') opts = ["PAI"];
        if(currentUser.role === 'inggris') opts = ["Bahasa Inggris"];

        sM.innerHTML = opts.map(x => `<option value="${x}">${x}</option>`).join('');
        document.getElementById('od-w').style.display = (k <= 2) ? 'none' : 'block';

        db.ref('kkg_tp').on('value', snap => {
            cacheTP = snap.val() ? Object.values(snap.val()).filter(x => x.k == k && x.m == sM.value) : [];
            document.getElementById('bodyTP').innerHTML = cacheTP.map(d => `<tr><td>${d.e}</td><td>${d.tp}</td><td><button class="btn-sm btn-blue" onclick="editTP('${d.id}')">E</button></td></tr>`).join('');
            document.getElementById('sTP').innerHTML = cacheTP.map(d => `<option value="${d.tp}">${d.tp}</option>`).join('');
            
            db.ref('kkg_soal').on('value', snapS => {
                const dataS = snapS.val() ? Object.values(snapS.val()).filter(x => x.k == k && x.m == sM.value) : [];
                renderCetak(dataS, k);
            });
        });
    }

    function renderCetak(soals, kls) {
        document.getElementById('p-mapel-val').innerText = document.getElementById('selMapel').value;
        document.getElementById('p-kls-val').innerText = kls;
        const pg = soals.filter(x => x.bentuk === 'PG');
        const esai = soals.filter(x => x.bentuk === 'Esai');

        document.getElementById('p-naskah').innerHTML = pg.map((s, i) => {
            let opsi = (kls <= 2) 
                ? `<table style="width:100%; border:none;"><tr><td width="33%">a. ${s.oa}</td><td width="33%">b. ${s.ob}</td><td>c. ${s.oc}</td></tr></table>`
                : `<table style="width:100%; border:none;"><tr><td width="50%">a. ${s.oa}</td><td width="50%">b. ${s.ob}</td></tr><tr><td>c. ${s.oc}</td><td>d. ${s.od}</td></tr></table>`;
            return `<table class="table-naskah"><tr><td width="25"><b>${i+1}.</b></td><td>${s.tanya}${opsi}</td></tr></table>`;
        }).join('');

        document.getElementById('p-naskah-esai').innerHTML = esai.map((s, i) => `<table class="table-naskah"><tr><td width="25"><b>${pg.length+i+1}.</b></td><td>${s.tanya}</td></tr></table>`).join('');
        document.getElementById('listSoal').innerHTML = soals.map(s => `<div class="card">${s.tanya} <button onclick="deleteSoal('${s.id}')">X</button></div>`).join('');
    }

    // 3. FUNGSI DOWNLOAD WORD (PERBAIKAN LOGO & JARAK)
    function downloadWord() {
        const logo = document.getElementById('p-logo').src;
        const mapel = document.getElementById('p-mapel-val').innerText;
        const kls = document.getElementById('p-kls-val').innerText;
        const naskah = document.getElementById('p-naskah').innerHTML;
        const esai = document.getElementById('p-naskah-esai').innerHTML;

        const html = `
<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
<head><meta charset='utf-8'>
<style>
    @page Section1 {size:595.3pt 841.9pt; margin:0.75in 0.75in 0.75in 0.75in;}
    div.Section1 {page:Section1;}
    body { font-family: "Arial", sans-serif; font-size: 11pt; }
    .t-kop { width: 100%; border-bottom: 3px double black; margin-bottom: 10px; border-collapse: collapse; }
    .t-id { width: 100%; margin-bottom: 10px; font-weight: bold; font-size: 10pt; border-collapse: collapse; }
    .inst { border: 1px solid black; padding: 3px; font-weight: bold; font-size: 10pt; margin: 5px 0; background: #eee; text-align:center; }
    table, td { border: none !important; padding: 1px 0; vertical-align: top; }
</style>
</head>
<body>
<div class='Section1'>
    <table class='t-kop'>
        <tr>
            <td width='12%' align='left'><img src='${logo}' style='width:65px;'></td>
            <td align='center' style='font-size:12pt; font-weight:bold; line-height:1.1;'>
                SUMATIF TENGAH SEMESTER (STS)<br>SEMESTER 2 SEKOLAH DASAR<br>TAHUN AJARAN 2025/2026
            </td>
            <td width='12%'></td>
        </tr>
    </table>
    <table class='t-id'>
        <tr><td width="18%">Mata Pelajaran</td><td width="2%">:</td><td width="35%">${mapel}</td><td width="12%">Nama</td><td width="2%">:</td><td width="31%">..................</td></tr>
        <tr><td>Kelas</td><td>:</td><td>${kls}</td><td>Nomor</td><td>:</td><td>..................</td></tr>
    </table>
    <div class='inst'>I. PILIHAN GANDA</div>
    ${naskah}
    <div class='inst' style='margin-top:10px;'>II. ESAI</div>
    ${esai}
</div>
</body></html>`;

        const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `Soal_STS2_${mapel}_Kls${kls}.doc`; a.click();
    }

    // UTILS
    function saveTP() {
        const id = document.getElementById('fIdTp').value || Date.now();
        db.ref('kkg_tp/'+id).set({ id, k: document.getElementById('selKls').value, m: document.getElementById('selMapel').value, e: document.getElementById('fElemen').value, tp: document.getElementById('fTp').value })
        .then(() => { document.getElementById('fElemen').value=""; document.getElementById('fTp').value=""; });
    }
    function saveSoal() {
        const id = document.getElementById('fIdSoal').value || Date.now();
        db.ref('kkg_soal/'+id).set({ id, k: document.getElementById('selKls').value, m: document.getElementById('selMapel').value, tp: document.getElementById('sTP').value, ind: document.getElementById('sInd').value, lv: document.getElementById('sLv').value, bentuk: document.getElementById('sBentuk').value, tanya: document.getElementById('sTanya').value, oa: document.getElementById('oa').value, ob: document.getElementById('ob').value, oc: document.getElementById('oc').value, od: document.getElementById('od').value, kunci: document.getElementById('sKunci').value, skor: document.getElementById('sSkor').value })
        .then(() => alert("Ok"));
    }
    function updateLogo(i) { if(i.files[0]){ const r=new FileReader(); r.onload=e=>{ document.getElementById('p-logo').src=e.target.result; document.getElementById('logo-preview').src=e.target.result; localStorage.setItem('kkg_logo', e.target.result); }; r.readAsDataURL(i.files[0]); } }
    function showTab(id) { document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden')); document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); document.getElementById('tab-'+id).classList.remove('hidden'); document.querySelector(`[onclick="showTab('${id}')"]`).classList.add('active'); }
    function toggleForm() { document.getElementById('panelPG').style.display = (document.getElementById('sBentuk').value === 'PG') ? 'block' : 'none'; }
    window.onload = () => { const l=localStorage.getItem('kkg_logo'); if(l){ document.getElementById('p-logo').src=l; document.getElementById('logo-preview').src=l; } };
</script>
</body>
</html>
