<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi KKG 2026 - Integrasi Mesin Cetak</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <script src="https://unpkg.com/docx@7.1.1/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        :root { --p: #1e293b; --a: #2563eb; --s: #10b981; --d: #ef4444; --w: #f59e0b; }
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; margin: 0; color: #1e293b; }
        header { background: var(--p); color: white; padding: 15px; text-align: center; border-bottom: 4px solid var(--a); }
        .nav { display: flex; background: white; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 100; }
        .nav-btn { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-weight: 600; color: #64748b; }
        .nav-btn.active { color: var(--a); border-bottom: 3px solid var(--a); background: #f8fafc; }
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; box-sizing: border-box; }
        .btn { padding: 10px 15px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; color: white; transition: 0.3s; }
        .btn-blue { background: var(--a); } .btn-green { background: var(--s); } .btn-red { background: var(--d); }
        .hidden { display: none; }
        #login-page { position: fixed; inset: 0; background: #f1f5f9; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #e2e8f0; padding: 10px; text-align: left; }
    </style>
</head>
<body>

<div id="login-page">
    <div class="card" style="width: 350px; text-align: center;">
        <h2>LOGIN KKG 2026</h2>
        <input type="text" id="lUser" placeholder="Username" style="margin-bottom:10px;">
        <input type="password" id="lPass" placeholder="Password" style="margin-bottom:20px;">
        <button class="btn btn-blue" style="width:100%;" onclick="doLogin()">MASUK</button>
    </div>
</div>

<header>
    <h2 id="header-title">ADMIN BANK SOAL KKG 2026</h2>
    <div id="db-st" style="font-size: 10px;">MENGHUBUNGKAN...</div>
</header>

<div class="nav">
    <button class="nav-btn active" onclick="showTab('tp')">A. TARGET PEMBELAJARAN</button>
    <button class="nav-btn" onclick="showTab('soal')">B. BANK SOAL</button>
    <button class="nav-btn" onclick="showTab('unduh')">C. UNDUH DOKUMEN</button>
</div>

<div class="container">
    <div class="card">
        <div class="grid">
            <div><label>Pilih Kelas</label><select id="selKls" onchange="initData()"></select></div>
            <div><label>Mata Pelajaran</label><select id="selMapel" onchange="initData()"></select></div>
        </div>
    </div>

    <div id="tab-tp" class="tab-content">
        <div class="card">
            <input type="text" id="fElemen" placeholder="Nama Elemen (Contoh: Pancasila)">
            <textarea id="fTp" placeholder="Tujuan Pembelajaran" style="margin: 10px 0;"></textarea>
            <button class="btn btn-blue" onclick="saveTP()">SIMPAN TP</button>
        </div>
        <div id="listTP"></div>
    </div>

    <div id="tab-soal" class="tab-content hidden">
        <div class="card">
            <select id="sTP" style="margin-bottom:10px;"><option value="">Pilih TP Terlebih Dahulu</option></select>
            <select id="sBentuk" onchange="toggleForm()" style="margin-bottom:10px;">
                <option value="PG">Pilihan Ganda</option>
                <option value="Esai">Isian Singkat</option>
            </select>
            <textarea id="sTanya" placeholder="Pertanyaan Soal" style="margin-bottom:10px;"></textarea>
            
            <div id="panelPG">
                <div class="grid">
                    <input type="text" id="oa" placeholder="Opsi A">
                    <input type="text" id="ob" placeholder="Opsi B">
                    <input type="text" id="oc" placeholder="Opsi C">
                    <input type="text" id="od" placeholder="Opsi D">
                </div>
            </div>
            
            <div style="margin-top:15px;">
                <label>Gambar Stimulus (Opsional)</label>
                <input type="file" id="fImg" accept="image/*" onchange="preImg(this, 'p-img')">
                <img id="p-img" class="hidden" style="max-height:100px; margin-top:5px;">
            </div>
            
            <button class="btn btn-green" onclick="saveSoal()" style="margin-top:15px; width:100%;">SIMPAN KE DATABASE</button>
        </div>
        <div id="listSoal"></div>
    </div>

    <div id="tab-unduh" class="tab-content hidden">
        <div class="card" style="text-align: center;">
            <h3>Ekspor Naskah Soal</h3>
            <p>Data akan disusun otomatis menjadi file Microsoft Word (.docx) menggunakan standar penulisan naskah ujian.</p>
            <button class="btn btn-blue" onclick="exportToWord()" style="padding: 15px 30px;">UNDUH FILE WORD (.DOCX)</button>
        </div>
    </div>
</div>

<script>
    // --- KONFIGURASI DATABASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyBA3VSLrRL6d9y0HdQM-H0Y7z2VisMHl_I",
        authDomain: "kkgmajalengka2026.firebaseapp.com",
        databaseURL: "https://kkgmajalengka2026-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "kkgmajalengka2026",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- LOGIKA LOGIN (index 28) ---
    function doLogin() {
        const u = document.getElementById('lUser').value;
        const p = document.getElementById('lPass').value;
        if(u === 'admin' && p === 'admin123') {
            document.getElementById('login-page').style.display = 'none';
            setupFilters();
        } else { alert("User/Pass Salah!"); }
    }

    function setupFilters() {
        const kls = document.getElementById('selKls');
        for(let i=1; i<=6; i++) kls.innerHTML += `<option value="${i}">Kelas ${i}</option>`;
        const mpls = ["Pendidikan Pancasila", "Bahasa Indonesia", "Matematika", "IPAS", "Seni Budaya", "PJOK", "Bahasa Inggris", "PAI"];
        mpls.forEach(m => document.getElementById('selMapel').innerHTML += `<option value="${m}">${m}</option>`);
        initData();
    }

    // --- LOGIKA MESIN CETAK (DARI INDEX 27) ---
    async function exportToWord() {
        const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, AlignmentType, BorderStyle, ImageRun } = docx;
        const kls = document.getElementById('selKls').value;
        const mapel = document.getElementById('selMapel').value;
        const fontName = kls <= 2 ? "Arial" : "Times New Roman";

        const snap = await db.ref('kkg_soal').once('value');
        const raw = snap.val() ? Object.values(snap.val()).filter(x => x.k == kls && x.m == mapel) : [];
        if(raw.length === 0) return alert("Data kosong!");

        const children = [];

        // Kop Header
        children.push(new Paragraph({
            alignment: AlignmentType.CENTER,
            children: [
                new TextRun({ text: "SUMATIF TENGAH SEMESTER (STS) SEMESTER 2", bold: true, size: 28, font: fontName }),
                new TextRun({ text: `\nMATA PELAJARAN: ${mapel.toUpperCase()}`, bold: true, size: 24, font: fontName }),
                new TextRun({ text: `\nTAHUN AJARAN 2025/2026`, size: 20, font: fontName })
            ]
        }));
        children.push(new Paragraph({ text: "", border: { bottom: { color: "auto", space: 1, value: BorderStyle.DOUBLE, size: 6 } }, spacing: { after: 200 } }));

        // Judul Bagian I
        children.push(new Paragraph({
            children: [new TextRun({ text: "I. Berilah tanda silang (x) pada huruf a, b, c, atau d di depan jawaban yang paling benar!", bold: true, font: fontName })],
            spacing: { before: 200, after: 200 }
        }));

        // Render Soal menggunakan Logika Tabel (index 27)
        raw.forEach((s, idx) => {
            const rowContent = [];
            rowContent.push(new Paragraph({
                children: [new TextRun({ text: s.tanya, font: fontName })],
                spacing: { after: 100 }
            }));

            if(s.imgS) {
                try {
                    rowContent.push(new Paragraph({
                        children: [new ImageRun({
                            data: Uint8Array.from(atob(s.imgS.split(',')[1]), c => c.charCodeAt(0)),
                            transformation: { width: 150, height: 100 }
                        })]
                    }));
                } catch(e) {}
            }

            if(s.bentuk === 'PG') {
                const labels = ['a', 'b', 'c', 'd'];
                const opts = [s.oa, s.ob, s.oc, s.od];
                for(let i=0; i < (kls <= 2 ? 3 : 4); i++) {
                    rowContent.push(new Paragraph({
                        indent: { left: 400 },
                        children: [new TextRun({ text: `${labels[i]}. ${opts[i]}`, font: fontName })]
                    }));
                }
            }

            children.push(new Table({
                width: { size: 100, type: WidthType.PERCENTAGE },
                borders: BorderStyle.NONE,
                rows: [
                    new TableRow({
                        children: [
                            new TableCell({ width: { size: 5, type: WidthType.PERCENTAGE }, borders: BorderStyle.NONE, children: [new Paragraph({ children: [new TextRun({ text: `${idx+1}.`, font: fontName, bold: true })] })] }),
                            new TableCell({ width: { size: 95, type: WidthType.PERCENTAGE }, borders: BorderStyle.NONE, children: rowContent })
                        ]
                    })
                ]
            }));
            children.push(new Paragraph({ text: "", spacing: { after: 100 } }));
        });

        const doc = new Document({ sections: [{ children }] });
        Packer.toBlob(doc).then(blob => {
            saveAs(blob, `SOAL_${mapel}_KLS${kls}.docx`);
        });
    }

    // --- FUNGSI PEMBANTU LAINNYA ---
    function showTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-'+id).classList.remove('hidden');
        event.currentTarget.classList.add('active');
    }

    function toggleForm() {
        document.getElementById('panelPG').style.display = (document.getElementById('sBentuk').value === 'PG') ? 'block' : 'none';
    }

    function preImg(input, targetId) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                const img = document.getElementById(targetId);
                img.src = e.target.result;
                img.classList.remove('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // (Tambahkan fungsi saveTP, saveSoal, initData dsb dari index 28 Anda di sini)
</script>

</body>
</html>
